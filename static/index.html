<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microlife æ™ºèƒ½åŠ©æ‰‹ (ç ”ç©¶ç‰ˆ)</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: false,
            theme: 'neutral',
            securityLevel: 'loose', // å…è¨±æ¸²æŸ“ HTML æ¨™ç±¤
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                rankSpacing: 50,
                nodeSpacing: 50
            }
        });
        window.mermaid = mermaid;
    </script>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f7f6;
            --user-bubble: #007bff;
            --agent-bubble: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            gap: 20px;
            /* ç‚ºçœ‹æ¿ç•™å‡ºé–“è· */
        }

        /* èŠå¤©ä¸»å®¹å™¨ */
        .chat-container {
            width: 100%;
            max-width: 450px;
            height: 85vh;
            background: white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ç ”ç©¶çœ‹æ¿ï¼šé¡¯ç¤ºæµç¨‹åœ– */
        .research-board {
            width: 500px;
            /* å¼·åˆ¶å›ºå®šå¯¬åº¦ */
            height: 800px;
            /* å¼·åˆ¶å›ºå®šé«˜åº¦ */
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* é¿å…å…§å®¹æº¢å‡ºçœ‹æ¿ */
        }

        #graph-container {
            flex: 1;
            width: 100%;
            height: 100%;
            /* å¡«æ»¿çœ‹æ¿å‰©ä¸‹çš„ç©ºé–“ */
            overflow: auto;
            /* é—œéµï¼šå…§å®¹è¶…é 500x850 æ™‚é¡¯ç¤ºæ²è»¸ */
            border: 1px inset #f0f0f0;
            border-radius: 8px;
            background: #fafafa;
        }

        .board-header {
            font-weight: bold;
            color: #555;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* Mermaid æ¸²æŸ“å€åŸŸ */
        #mermaid-graph {
            display: block;
            width: 100%;
            margin: 0 auto;
            /* ç¢ºä¿åˆå§‹æ–‡å­—åœ¨æ¸²æŸ“å‰æ˜¯éš±è—çš„ï¼Œé¿å…é–ƒçˆ */
            min-height: 200px;
        }

        .mermaid svg {
            /* è®“ SVG ä¾ç…§å…§å®¹å¯¬åº¦æ’é–‹ï¼Œä½†å¯¬åº¦è‡³å°‘ 100% */
            min-width: 450px;
            width: 100% !important;
            max-height: 700px;
        }

        /* èŠå¤©å…§å®¹å€ */
        .chat-header {
            background: var(--primary-color);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
        }

        #chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* æ°£æ³¡æ¨£å¼èˆ‡ä¹‹å‰ç›¸åŒ... */
        .msg {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .user-msg {
            align-self: flex-end;
            background-color: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .agent-msg {
            align-self: flex-start;
            background-color: var(--agent-bubble);
            color: #333;
            border: 1px solid #eee;
            border-bottom-left-radius: 4px;
        }

        /* é«˜äº® Mermaid ç¯€é»çš„ CSS */
        .activeNode>rect {
            fill: #ffcc00 !important;
            stroke: #ff9900 !important;
            stroke-width: 3px !important;
        }

        .input-area {
            padding: 15px;
            display: flex;
            gap: 10px;
            background: white;
            border-top: 1px solid #eee;
        }

        #userInput {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
        }

        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
        }

        .activeEmergencyNode>rect {
            fill: #ff4d4d !important;
            stroke: #b30000 !important;
        }
    </style>
</head>

<body>

    <div class="chat-container">
        <div class="chat-header">Microlife æ™ºèƒ½åŠ©æ‰‹</div>
        <div id="chat-box">
            <div class="msg agent-msg">
                æ‚¨å¥½ï¼æˆ‘æ˜¯ <b>Microlife å°ˆå±¬æ™ºèƒ½åŠ©ç†</b>ã€‚<br>
                æˆ‘å°ˆç²¾æ–¼ç‚ºæ‚¨è§£æ±º Microlife ç”¢å“ç›¸é—œå•é¡Œï¼š<br><br>
                ğŸ”§ <b>ç¡¬é«”æ”¯æ´</b>ï¼šè¨­å‚™è¨­ç½®åŠæ‰‹å†Šå¼•å°ã€‚<br>
                ğŸ“Š <b>å€‹äººå¥åº·åˆ†æ</b>ï¼šè§£è®€è¡€å£“ã€è¡€æ°§ç­‰è¶¨å‹¢ä¸¦æä¾›é¢¨éšªé è­¦ã€‚<br><br>
                è«‹è¼¸å…¥æ‚¨çš„è¨­å‚™ç‹€æ…‹æˆ–æ¸¬é‡æ•¸å€¼ï¼Œæˆ‘å°‡ç‚ºæ‚¨é€²è¡Œåˆ†æã€‚
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="è«‹è¼¸å…¥å•é¡Œ...">
            <button onclick="sendMessage()">é€å‡º</button>
        </div>
    </div>
    <div class="research-board">
        <div class="board-header">LangGraph æ±ºç­–è¿½è¹¤ (ç ”ç©¶ç‰ˆ)</div>
        <div id="intent-display" style="font-size: 0.8em; color: #888; margin-bottom: 10px;">ç³»çµ±ç‹€æ…‹ï¼šå°±ç·’</div>
        <div id="graph-container">
            <pre class="mermaid" id="mermaid-graph">
            graph TD
            START((START)) --> Router{Intent Router}
    
            Router -- Hardware Issues --> device_expert[Device Expert]
            Router -- Health Data --> health_analyst[Health Analyst]
            Router -- Chat/Others --> general_assistant[General Assistant]
    
            %% Condition Branch
            health_analyst --> IsEmergency{Risk Assessment}
            IsEmergency -- Abnormal --> emergency_advice[Emergency Advice]
            IsEmergency -- Normal --> END((END))
    
            device_expert --> END
            general_assistant --> END
            emergency_advice --> END     
        </pre>
        </div>
    </div>

    <script>
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const chatBox = document.getElementById('chat-box');
            const message = input.value.trim();
            if (!message) return;

            chatBox.innerHTML += `<div class="msg user-msg">${message}</div>`;
            input.value = '';

            const loadingId = "loading-" + Date.now();
            chatBox.innerHTML += `<div class="msg agent-msg" id="${loadingId}">åˆ†æè·¯å¾‘ä¸­...</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message, userId: "default-user" })
                });

                const json = await response.json();
                const payload = json.data;

                // 1. æ›´æ–°æ–‡å­—
                document.getElementById(loadingId).innerText = payload.text;

                // 2. æ›´æ–°ç ”ç©¶çœ‹æ¿é¡¯ç¤º
                const intentText = payload.intent.toUpperCase();
                const emergencyTag = payload.is_emergency ? " <span style='color:red;'>(è§¸ç™¼é è­¦)</span>" : "";
                document.getElementById('intent-display').innerHTML = `æ„åœ–è¾¨è­˜ï¼š${intentText}${emergencyTag}`;

                // 3. è™•ç† Mermaid ç¹ªåœ–
                const graphContainer = document.getElementById('mermaid-graph');

                // é‡è¦ï¼šåœ¨æ›´æ–°å…§å®¹å‰ç§»é™¤èˆŠçš„ processed å±¬æ€§ï¼Œå¦å‰‡ mermaid ä¸æœƒé‡ç¹ª
                graphContainer.removeAttribute('data-processed');

                let mermaidCode = payload.graph;

                // æ ¹æ“šæ„åœ–èˆ‡ç·Šæ€¥ç‹€æ…‹å‹•æ…‹æ·»åŠ é«˜äº®é¡åˆ¥
                // é€™è£¡çš„ ID (device_expert ç­‰) å¿…é ˆèˆ‡ä½  Python ç”¢ç”Ÿçš„ mermaid ID å®Œå…¨ä¸€è‡´
                if (payload.intent === 'device') mermaidCode += '\nclass device_expert activeNode';
                if (payload.intent === 'health') mermaidCode += '\nclass health_analyst activeNode';
                if (payload.intent === 'general') mermaidCode += '\nclass general_assistant activeNode';

                // é—œéµï¼šå¦‚æœè§¸ç™¼ç·Šæ€¥ç‹€æ…‹ï¼ŒåŒæ™‚é«˜äº®åˆ†æå¸«èˆ‡ç·Šæ€¥å»ºè­°ç¯€é»
                if (payload.is_emergency) {
                    mermaidCode += '\nclass emergency_advice activeEmergencyNode';
                }
                // æ›´æ–° HTML å…§å®¹
                graphContainer.innerHTML = mermaidCode;

                // æ‰‹å‹•é‡æ–°æ¸²æŸ“ (v10+ æ¨è–¦åšæ³•)
                await mermaid.run({
                    nodes: [graphContainer]
                });
                const svgElement = graphContainer.querySelector('svg');
                if (svgElement) {
                    svgElement.style.maxWidth = 'none';
                    svgElement.style.width = '100%';
                    svgElement.style.height = 'auto';
                }
            } catch (error) {
                console.error("RAG Error:", error);
                document.getElementById(loadingId).innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ—¥èªŒã€‚";
            } finally {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
        window.addEventListener('DOMContentLoaded', async () => {
            const graphContainer = document.getElementById('mermaid-graph');
            if (graphContainer) {
                // ç¢ºä¿ mermaid å·²ç¶“è¼‰å…¥
                try {
                    await mermaid.run({
                        nodes: [graphContainer]
                    });
                    console.log("ğŸš€ [System] é è¨­æµç¨‹åœ–æ¸²æŸ“æˆåŠŸ");
                } catch (e) {
                    console.error("âŒ [System] é è¨­æµç¨‹åœ–æ¸²æŸ“å¤±æ•—:", e);
                }
            }
        });
    </script>
</body>

</html>