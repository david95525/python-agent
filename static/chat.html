<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microlife æ™ºèƒ½åŠ©æ‰‹</title>
    <link rel="stylesheet" href="/static/css/chat.css">
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });
        window.mermaid = mermaid;
    </script>
</head>

<body>
    <div class="chat-container">
        <div class="chat-header">æ™ºèƒ½åŠ©æ‰‹(LangGraphç‰ˆ)</div>
        <div id="chat-box">
            <div class="msg agent-msg">
                æ‚¨å¥½ï¼æˆ‘æ˜¯ <b>å°ˆå±¬æ™ºèƒ½åŠ©ç†</b>ã€‚<br>
                æˆ‘å°ˆç²¾æ–¼ç‚ºæ‚¨è§£æ±º é†«ç™‚ç”¢å“ç›¸é—œå•é¡Œï¼š<br><br>
                ğŸ”§ <b>ç¡¬é«”æ”¯æ´</b>ï¼šè¨­å‚™è¨­ç½®åŠæ‰‹å†Šå¼•å°ã€‚<br>
                ğŸ“Š <b>å€‹äººå¥åº·åˆ†æ</b>ï¼šè§£è®€è¡€å£“ã€è¡€æ°§ç­‰è¶¨å‹¢ä¸¦æä¾›é¢¨éšªé è­¦ã€‚<br><br>
                è«‹è¼¸å…¥æ‚¨çš„è¨­å‚™ç‹€æ…‹æˆ–æ¸¬é‡æ•¸å€¼ï¼Œæˆ‘å°‡ç‚ºæ‚¨é€²è¡Œåˆ†æã€‚
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="è«‹è¼¸å…¥å•é¡Œ...">
            <button id="sendBtn">é€å‡º</button>
        </div>

    </div>
    <div class="research-board">
        <div class="board-header">LangGraph æ±ºç­–è¿½è¹¤</div>
        <div id="intent-display" style="font-size: 0.8em; color: #888; margin-bottom: 10px;">ç³»çµ±ç‹€æ…‹ï¼šå°±ç·’</div>
        <div id="graph-container">
            <pre class="mermaid" id="mermaid-graph">
            graph TD
            START((START)) --> Router{Intent Router}
    
            Router -- Hardware Issues --> device_expert[Device Expert]
            Router -- Health Data --> health_analyst[Health Analyst]
            Router -- Chat/Others --> general_assistant[General Assistant]
    
            %% Condition Branch
            health_analyst --> IsEmergency{Risk Assessment}
            IsEmergency -- Abnormal --> emergency_advice[Emergency Advice]
            IsEmergency -- Normal --> END((END))
    
            device_expert --> END
            general_assistant --> END
            emergency_advice --> END     
        </pre>
        </div>
    </div>
    <script src="/static/js/chat.js"></script>
    <script>
        async function updateMermaidGraph(code, intent, isEmergency) {
            if (!window.mermaid) return;
            const container = document.getElementById('mermaid-graph');
            container.removeAttribute('data-processed');

            let mermaidCode = code;
            // ä¿®æ­£ï¼šå°æ‡‰å¾Œç«¯å¯èƒ½çš„ç¯€é»åç¨±
            const activeClass = isEmergency ? 'activeEmergencyNode' : 'activeNode';
            mermaidCode += `\nclass ${intent} ${activeClass}`;

            container.innerHTML = mermaidCode;
            await mermaid.run({ nodes: [container] });
        }
        window.updateMermaidGraph = updateMermaidGraph;
    </script>
</body>

</html>